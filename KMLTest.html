<head>
	<script type="text/plain" id="test-source-1"><?xml version="1.0" encoding="UTF-8"?>
	<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2" xmlns:kml="http://www.opengis.net/kml/2.2" xmlns:atom="http://www.w3.org/2005/Atom">
	<Document>
		<name>TestP1.kml</name>
		<Style id="sn_ylw-pushpin">
			<IconStyle>
				<scale>1.1</scale>
				<Icon>
					<href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
				</Icon>
				<hotSpot x="20" y="2" xunits="pixels" yunits="pixels"/>
			</IconStyle>
			<PolyStyle>
				<color>ff18a764</color>
			</PolyStyle>
		</Style>
		<StyleMap id="msn_ylw-pushpin">
			<Pair>
				<key>normal</key>
				<styleUrl>#sn_ylw-pushpin</styleUrl>
			</Pair>
			<Pair>
				<key>highlight</key>
				<styleUrl>#sh_ylw-pushpin</styleUrl>
			</Pair>
		</StyleMap>
		<Style id="sh_ylw-pushpin">
			<IconStyle>
				<scale>1.3</scale>
				<Icon>
					<href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
				</Icon>
				<hotSpot x="20" y="2" xunits="pixels" yunits="pixels"/>
			</IconStyle>
			<PolyStyle>
				<color>ff18a764</color>
			</PolyStyle>
		</Style>
		<Placemark>
			<name>TestP1</name>
			<styleUrl>#msn_ylw-pushpin</styleUrl>
			<Polygon>
				<tessellate>1</tessellate>
				<outerBoundaryIs>
					<LinearRing>
						<coordinates>
139.8524248388972,35.64526308586525,0
139.8545836781609,35.64418324876138,0
139.8559652925388,35.64602515401978,0
139.8619763782636,35.64500606098855,0
139.8625581235314,35.65049641183028,0
139.8507390854652,35.65311289534171,0
139.8498433949071,35.64289685248417,0
139.8524248388972,35.64526308586525,0 
						</coordinates>
					</LinearRing>
				</outerBoundaryIs>

				<innerBoundaryIs>
					<LinearRing>
						<coordinates>
						139.8547897831066,35.64952679731244,0
						139.852931753997,35.64805987155131,0
						139.853028184009,35.65116768678917,0
						139.8573400046863,35.65044164358734,0
						139.8567715453534,35.64696027254656,0
						139.8547897831066,35.64952679731244,0 
						</coordinates>
					</LinearRing>
				</innerBoundaryIs>

			</Polygon>
		</Placemark>
	</Document>
	</kml>
	</script>

	<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="inner/js/jquery-1.10.2.js"></script>
	<script type="text/javascript" src="inner/js/mm-utils.js"></script>
	<script type="text/javascript" src="inner/js/data/MMKMLLoader.js"></script>

	<script type="text/javascript">
var gmap = null;

var QueryLines = [
	[35.657296,139.853983,  35.63979,139.850121],
	[35.657174,139.861096,  35.64599,139.858449],
	[35.657174,139.88,  35.64599,139.88],
	[35.65,139.86,  35.64599,139.86],
	[35.65,139.855,  35.649,139.856]
];

var TestColors = ['#00f', '#f00', '#0f0', '#088', '#dd0'];

function setupMap() {
	var box = document.getElementById('map-box');
	
	var mapOptions = {
	          center: new google.maps.LatLng(35.65, 139.85),
	          zoom: 12,
	          mapTypeId: google.maps.MapTypeId.ROADMAP
	        };

	gmap = new google.maps.Map(box, mapOptions);
}

function observeTestClick(targetPolygon, e) {
	var ll = e.latLng;
	var hit = google.maps.geometry.poly.containsLocation(ll, targetPolygon);
	
	console.log(ll.lat(), ll.lng(), hit);
	
}

function doCrossTest(lineList, mmpolygon) {
	var should_be = [true, true, false, true,false];
	
	for (var i in lineList) {
		var ln = lineList[i];
		var y1 = ln[0];
		var x1 = ln[1];
		var y2 = ln[2];
		var x2 = ln[3];
		
		var g_polyline = new google.maps.Polyline({
			path: [ new google.maps.LatLng(y1, x1) , new google.maps.LatLng(y2, x2) ],
			map: gmap,
			strokeColor: TestColors[i-0]
		});
		
		var hit = mmpolygon.checkCrossOrContain(x1, y1, x2, y2);
		console.log(i, hit)
		if (should_be[i-0] !== hit) {
			console.log("     **** BAD ****")
		}
	}
}

function launch_test() {
	setupMap();
	
	var sourceXML = $('#test-source-1').text();
	var parser = new DOMParser();
	var xmlDoc = parser.parseFromString(sourceXML, "application/xml");
	var valid = mobmap.KMLLoader.isDocumentValid(xmlDoc);
	console.log(valid);
	
	var loader = new mobmap.KMLLoader(xmlDoc);
	var n = loader.getNumOfPolygons();
	var pg = loader.getPolygonAt(0);
	
	console.log((n == 1) ? 'N : OK' : 'N : **BAD**' );
	console.log(pg ? 'Pg: OK' : 'Pg: **BAD**' );
	
	var polygon = pg.getGMapPolygon();
	polygon.setMap(gmap);
	
	google.maps.event.addListener(polygon, 'click', observeTestClick.bind(null, polygon));
	google.maps.event.addListener(gmap, 'click', observeTestClick.bind(null, polygon));
	
	setTimeout(function(){
		doCrossTest(QueryLines, pg);
	}, 200);
}

	</script>
</head>
<body onload="void launch_test()">
	<div id="map-box" style="height: 380px">
	</div>
</body>